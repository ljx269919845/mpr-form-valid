!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/forms"),require("@angular/common")):"function"==typeof define&&define.amd?define("mpr-form-valid",["exports","@angular/core","@angular/forms","@angular/common"],t):t(r["mpr-form-valid"]={},r.ng.core,r.ng.forms,r.ng.common)}(this,function(r,t,s,o){"use strict";var e=function(){function r(){this.validMsg=new Map}return r.prototype.registerMsg=function(r,t){if(!r||!t)throw new Error("msg key and value must not empty");this.validMsg.set(r,t)},r.prototype.getMsg=function(r){return r?this.validMsg.get(r):null},r}(),n=new e,i=function(){function r(){this.validMsg={}}return r.prototype.setValidMsg=function(r,t){t&&(this.validMsg[r]=t)},r.prototype.getValidMsg=function(r,t){if(!t||!r)return"";for(var o in t)if(t[o])return this.validMsg[r+"."+o]||n.getMsg(o);return""},r.prototype.resetMsg=function(r){if("object"!=typeof r)throw Error("form valid msg must be a object");for(var t in this.validMsg={},r)"object"!=typeof r[t]?this.validMsg[t]=r[t]:this.formatMsg(r[t],t,this.validMsg)},r.prototype.formatMsg=function(r,t,o){for(var e in r)"object"!=typeof r[e]?o[t+"."+e]=r[e]:this.formatMsg(r[e],t+"."+e,o)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[]},r}(),a=function(){function r(){this.validForms=[]}return r.prototype.registerValidForm=function(t){var r=this.validForms.findIndex(function(r){return r.form==t});0<=r?this.validForms[r].count+=1:this.validForms.push({form:t,count:1})},r.prototype.validAll=function(){var t=!0;return this.validForms.forEach(function(r){r.form.patchValue(r.form.value,{emitModelToViewChange:!1,emitViewToModelChange:!1,onlySelf:!0}),t=r.form.valid&&t}),t},r.prototype.unregisterValidForm=function(t){var r=this.validForms.findIndex(function(r){return r.form==t});0<=r&&1<this.validForms[r].count?this.validForms[r].count-=1:this.validForms.splice(r,1)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[]},r}(),l="mpr-form-control-valid",u=function(){function r(r,t,o,e,n){this.container=t,this.errMsgServ=o,this.globalValidServ=e,this.elemRef=n,this.onlyGroup=!1,this.groupValidControlLength=1,r&&(this.controlName=r.replace(/'/g,""))}return r.prototype.ngOnInit=function(){},r.prototype.ngAfterContentInit=function(){var r=this;Promise.resolve(null).then(function(){r.bindControlErrorMsg()})},r.prototype.bindControlErrorMsg=function(){var r=this;if(this.controlName=this.getFormControlName(),!this.controlName)throw new Error("can't find controlName");console.log(this.controlName);var t="";if(this.container.control.get(this.controlName)&&this.container.control.get(this.controlName)instanceof s.FormControl?(this.formControl=this.container.control.get(this.controlName),t=this.getPath(this.formControl,this.formControl.root,this.controlName),this.formControl.valueChanges.subscribe(function(){r.errorMsg=r.errMsgServ.getValidMsg(t||r.controlName,r.formControl.errors)})):(this.formControl=this.container.control,t=this.getPath(this.formControl,this.formControl.root,this.controlName),this.formControl.valueChanges.subscribe(function(){r.onlyGroup?r.errorMsg=r.errMsgServ.getValidMsg(t||r.controlName,r.formControl.errors):r.errorMsg=r.getGroupControlValidMsg(r.formControl,t||r.controlName)})),!this.formControl)throw new Error("formControl instance not find");this.globalValidServ.registerValidForm(this.formControl.root||this.formControl)},r.prototype.ngOnDestroy=function(){this.globalValidServ.unregisterValidForm(this.formControl.root||this.formControl)},r.prototype.getGroupControlValidMsg=function(r,t){if(r instanceof s.FormControl)return this.errMsgServ.getValidMsg(t,r.errors);var o;for(var e in r.controls)if(o=this.getGroupControlValidMsg(r.get(e),t+"."+e))return o;return this.errMsgServ.getValidMsg(t,r.errors)},r.prototype.getParentGroupELem=function(){var r=this.elemRef.nativeElement.parentElement;for(console.log(r.getAttribute("ng-reflect-form"));!r.getAttribute("formgroupname")&&!r.getAttribute("formGroupName")&&!r.getAttribute("ng-reflect-form")&&"form"!==r.nodeName.toLocaleLowerCase()&&"ngform"!==r.nodeName.toLocaleLowerCase();)r=r.parentElement;if(!r)throw new Error("can not find parentElement");return r},r.prototype.getSlibingFormContrlElem=function(r){for(var t=r.previousElementSibling;t&&!t.hasAttribute("formcontrolname")&&!t.hasAttribute("formControlName")&&!t.hasAttribute("name");)t=t.previousElementSibling;if(!t)throw new Error("mpr-form-control-valid must have a formcontrol sibiling");return t},r.prototype.getFormControlName=function(){if(this.controlName)return this.controlName;var r;if(!this.container)throw new Error("only one [formControl] not support, There must be a formGroupName or [formGroup]");var t=this.getParentGroupELem(),o=t.querySelectorAll(l).length;if(this.groupValidControlLength=o,this.container instanceof s.FormGroupDirective&&o<=1)throw new Error("you should set controlName by yourself");if(this.container instanceof s.FormGroupName&&o<=1)r=t.getAttribute("formgroupname")||t.getAttribute("fromGroupName");else if(this.container instanceof s.NgModelGroup&&o<=1)r=this.container.name;else{var e=this.getSlibingFormContrlElem(this.elemRef.nativeElement);r=e.getAttribute("formcontrolname")||e.getAttribute("formControlName")||e.getAttribute("name")}return r},r.prototype.getPath=function(r,t,o){if(!(t instanceof s.FormGroup))return r===t?o:"";var e=[];for(var n in t.controls){if(t.controls[n]===r)return n;if(t.controls[n]instanceof s.FormGroup){var i=this.getPath(r,t.controls[n],o);if(i)return e.push(n),e.push(i),e.join(".")}}return e.join(".")},r.decorators=[{type:t.Component,args:[{selector:l,template:'<span\n    class="error"\n    [ngClass]="errorPrompt"\n    [hidden]="!errorMsg"\n>\n    <ng-container\n        [ngTemplateOutlet]="template"\n        [ngTemplateOutletContext]="{errorMsg:errorMsg}"\n    ></ng-container>\n    <p *ngIf="!template">{{errorMsg}}</p>\n</span>\n',styles:["p{width:100%;height:17px;line-height:17px;color:#e06a2f;float:left}"]}]}],r.ctorParameters=function(){return[{type:String,decorators:[{type:t.Attribute,args:["controlName"]}]},{type:s.ControlContainer,decorators:[{type:t.Optional}]},{type:i},{type:a},{type:t.ElementRef}]},r.propDecorators={onlyGroup:[{type:t.Input}],errorPrompt:[{type:t.Input}],template:[{type:t.ContentChild,args:[t.TemplateRef]}]},r}(),c=function(){function r(r){this.msgServ=r}return Object.defineProperty(r.prototype,"validMsg",{set:function(r){r&&this.msgServ.resetMsg(r)},enumerable:!0,configurable:!0}),r.decorators=[{type:t.Directive,args:[{selector:"[isliFormValidMsg]",providers:[i]}]}],r.ctorParameters=function(){return[{type:i}]},r.propDecorators={validMsg:[{type:t.Input,args:["isliFormValidMsg"]}]},r}(),f={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return m}),multi:!0},m=function(){function r(){n.registerMsg("isbn","请输入正确的ISBN号")}return r.prototype.validate=function(r){if(!(r instanceof s.FormGroup))throw new Error("isbn must be a group control");var t=r.value;return t.isbn1&&t.isbn2&&t.isbn3&&t.isbn4&&t.isbn5&&this.validISBNCode([t.isbn1,t.isbn2,t.isbn3,t.isbn4,t.isbn5].join(""))?{isbn:!0}:null},r.prototype.validISBNCode=function(r){if("9999999999999"===r)return!0;if(!this.isBarCode(r))return!1;for(var t,o=0,e=0,n=1;n<=12;n++){var i=parseInt(r[n-1],10);n<=12&&n%2==0?o+=i:n<=11&&n%2==1&&(e+=i)}return((t=e+3*o)%10==0?t-t:t+(10-t%10)-t)===parseInt(r[12],10)},r.prototype.isBarCode=function(r){return 13===r.length&&null!=new RegExp(/^[0-9]{12}$/).exec(r.substring(0,12))},r.decorators=[{type:t.Directive,args:[{selector:"[mprIsbnValid]",providers:[f]}]}],r.ctorParameters=function(){return[]},r}(),p={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return g}),multi:!0},g=function(){function r(){n.registerMsg("isbnPart34","第三组和第四组一共为8位数字")}return r.prototype.validate=function(r){if(!(r instanceof s.FormGroup))throw new Error("isbn must be a group control");var t=r.value;return t.isbn3&&t.isbn4&&t.isbn3.length+t.isbn4.length!==8?{isbnPart34:!0}:null},r.decorators=[{type:t.Directive,args:[{selector:"[mprIsbnPartValid]",providers:[p]}]}],r.ctorParameters=function(){return[]},r}(),d={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return h}),multi:!0},h=function(){function r(){n.registerMsg("isbnHeader","第一组必须为978或979")}return r.prototype.validate=function(r){return r.value&&["999","978","979","000"].indexOf(r.value)<0?{isbnHeader:!0}:null},r.decorators=[{type:t.Directive,args:[{selector:"[mprIsbnHeaderValid]",providers:[d]}]}],r.ctorParameters=function(){return[]},r}(),v={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return b}),multi:!0},b=function(){function r(){n.registerMsg("float","请输入浮点数")}return r.prototype.validate=function(r){var t=parseFloat(""+r.value);return isNaN(t)?{"float":!0}:null},r.decorators=[{type:t.Directive,args:[{selector:"[mprFloatOnlyValidtor]",providers:[v]}]}],r.ctorParameters=function(){return[]},r}(),y=function(){function r(){}return r.decorators=[{type:t.NgModule,args:[{imports:[o.CommonModule,s.ReactiveFormsModule,s.FormsModule],declarations:[u,c,m,g,h,b],exports:[u,c,m,g,h,s.ReactiveFormsModule,s.FormsModule,b],providers:[a,i]}]}],r}();r.FormValidModule=y,r.GlobalValidService=a,r.globalValidMsgServ=n,r.FormValidMsgService=i,r.FormControlValidComponent=u,r.FloatOnlyValidtorDirective=b,r.IsbnHeaderValidDirective=h,r.IsbnPartValidDirective=g,r.IsbnValidtorDirective=m,r.ɵb=c,r.ɵa=e,Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=mpr-form-valid.umd.min.js.map