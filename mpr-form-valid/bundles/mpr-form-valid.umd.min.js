!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/forms"),require("@angular/common")):"function"==typeof define&&define.amd?define("mpr-form-valid",["exports","@angular/core","@angular/forms","@angular/common"],t):t(r["mpr-form-valid"]={},r.ng.core,r.ng.forms,r.ng.common)}(this,function(r,t,s,e){"use strict";var o=function(){function r(){this.validMsg=new Map}return r.prototype.registerMsg=function(r,t){if(!r||!t)throw new Error("msg key and value must not empty");this.validMsg.set(r,t)},r.prototype.getMsg=function(r){return r?this.validMsg.get(r):null},r}(),a=new o,n=function(){function r(){this.validMsg={}}return r.prototype.setValidMsg=function(r,t){t&&(this.validMsg[r]=t)},r.prototype.getValidMsg=function(r,t){var e,o,n=Number.MAX_VALUE,i="";if(!t||!r)return{errorMsg:i,minWeight:n};for(var s in t)(e=this.validMsg[r+"."+s]||a.getMsg(s))&&(o=Number.isNaN(Number(t[s]))?1e3:Number(t[s]))<n&&(n=o,i=e);return{errorMsg:i,minWeight:n}},r.prototype.resetMsg=function(r){if("object"!=typeof r)throw Error("form valid msg must be a object");for(var t in r)"object"!=typeof r[t]?this.validMsg[t]=r[t]:this.formatMsg(r[t],t,this.validMsg)},r.prototype.formatMsg=function(r,t,e){for(var o in r)"object"!=typeof r[o]?e[t+"."+o]=r[o]:this.formatMsg(r[o],t+"."+o,e)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[]},r}(),i=function(){function r(){this.validForms=[]}return r.prototype.registerValidForm=function(t){var r=this.validForms.findIndex(function(r){return r.form==t});0<=r?this.validForms[r].count+=1:this.validForms.push({form:t,count:1})},r.prototype.resetNull=function(){var e=this;this.validForms.forEach(function(r){r.form instanceof s.FormControl?(r.form.reset(null,{emitEvent:!1,onlySelf:!0}),r.form.setErrors(null,{emitEvent:!0})):(r.form.reset({},{emitEvent:!1,onlySelf:!0}),r.form.setErrors(null,{emitEvent:!1}),e.resetGroup(r.form)),r.sub&&r.sub.unsubscribe(),r.form._reset=!0;var t=r.form.valueChanges.subscribe(function(){r.form._reset=!1,r.sub.unsubscribe(),r.sub=null});r.sub=t})},r.prototype.validAll=function(){var t=this,e=!0;return this.validForms.forEach(function(r){r.form.valid&&!r.form._reset||(r.form._reset=!1,r.form instanceof s.FormControl?(console.log(r.form.status,r.form),r.form.statusChanges.emit(r.form.status),r.form.setValue(r.form.value,{emitModelToViewChange:!1,emitViewToModelChange:!1,onlySelf:!0,emitEvent:!1})):t.validFormGroup(r.form)),e=r.form.valid&&e}),e},r.prototype.unregisterValidForm=function(t){var r=this.validForms.findIndex(function(r){return r.form==t});0<=r&&1<this.validForms[r].count?this.validForms[r].count-=1:this.validForms.splice(r,1)},r.prototype.validFormGroup=function(r){var t=r.controls;for(var e in t)t.hasOwnProperty(e)&&(t[e]instanceof s.FormGroup&&this.validFormGroup(t[e]),t[e].valid&&!t[e]._reset||(t[e]._reset=!1,console.log(t[e].status,t[e]),t[e].statusChanges.emit(t[e].status),t[e].setValue(t[e].value,{emitModelToViewChange:!1,emitViewToModelChange:!1,onlySelf:!0,emitEvent:!1})))},r.prototype.resetGroup=function(r){var t=r.controls;for(var e in t)t.hasOwnProperty(e)&&(t[e]instanceof s.FormGroup?(t[e].setErrors(null,{emitEvent:!1}),this.resetGroup(t[e])):t[e].setErrors(null,{emitEvent:!0}),t[e]._reset=!0)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[]},r}(),l="mpr-form-control-valid",u=function(){function r(r,t,e,o,n){this.container=t,this.errMsgServ=e,this.globalValidServ=o,this.elemRef=n,this.onlyGroup=!1,this.groupValidControlLength=1,r&&(this.controlName=r.replace(/'/g,""))}return r.prototype.ngOnInit=function(){},r.prototype.ngAfterContentInit=function(){var r=this;Promise.resolve(null).then(function(){r.bindControlErrorMsg()})},r.prototype.bindControlErrorMsg=function(){var r=this;if(this.controlName=this.getFormControlName(),!this.controlName)throw new Error("can't find controlName");console.log(this.controlName);var t="";if(this.container.control.get(this.controlName)&&this.container.control.get(this.controlName)instanceof s.FormControl?(this.formControl=this.container.control.get(this.controlName),t=this.getPath(this.formControl,this.formControl.root,this.controlName),this.formControl.statusChanges.subscribe(function(){r.errorMsg=r.errMsgServ.getValidMsg(t||r.controlName,r.formControl.errors).errorMsg})):(this.formControl=this.container.control,t=this.getPath(this.formControl,this.formControl.root,this.controlName),this.formControl.statusChanges.subscribe(function(){r.onlyGroup?r.errorMsg=r.errMsgServ.getValidMsg(t||r.controlName,r.formControl.errors).errorMsg:r.errorMsg=r.getGroupControlValidMsg(r.formControl,t||r.controlName,{minWeight:Number.MAX_VALUE,errorMsg:""}).errorMsg})),!this.formControl)throw new Error("formControl instance not find");this.globalValidServ.registerValidForm(this.formControl.root||this.formControl)},r.prototype.ngOnDestroy=function(){this.globalValidServ.unregisterValidForm(this.formControl.root||this.formControl)},r.prototype.setFormControlMsgListener=function(r,t){var e=this;if(r.valueChanges.subscribe(function(){e.errMsgServ.getValidMsg(t||e.controlName,r.errors)}),r instanceof s.FormGroup)for(var o in r.controls)this.setFormControlMsgListener(r.get(o),t+"."+o)},r.prototype.getGroupControlValidMsg=function(r,t,e){if(r instanceof s.FormControl)return this.errMsgServ.getValidMsg(t,r.errors);var o;for(var n in r.controls)(o=this.getGroupControlValidMsg(r.get(n),t+"."+n,e)).minWeight<e.minWeight&&(e=o);return(o=this.errMsgServ.getValidMsg(t,r.errors)).minWeight<e.minWeight&&(e=o),e},r.prototype.getParentGroupELem=function(){for(var r=this.elemRef.nativeElement.parentElement;r&&!r.getAttribute("formgroupname")&&!r.getAttribute("formGroupName")&&!r.getAttribute("formgroup")&&"form"!==r.nodeName.toLocaleLowerCase()&&"ngform"!==r.nodeName.toLocaleLowerCase();)r=r.parentElement;if(!r)throw console.log(this.elemRef.nativeElement),new Error("can not find parentElement");return r},r.prototype.getSlibingFormContrlElem=function(r){for(var t=r.previousElementSibling;t&&!t.hasAttribute("formcontrolname")&&!t.hasAttribute("formControlName")&&!t.hasAttribute("name");)t=t.previousElementSibling;if(!t)throw new Error("mpr-form-control-valid must have a formcontrol sibiling");return t},r.prototype.getFormControlName=function(){if(this.controlName)return this.controlName;var r;if(!this.container)throw new Error("only one [formControl] not support, There must be a formGroupName or [formGroup]");var t=this.getParentGroupELem(),e=t.querySelectorAll(l).length;if(this.groupValidControlLength=e,this.container instanceof s.FormGroupDirective&&e<=1)throw new Error("you should set controlName by yourself");if(this.container instanceof s.FormGroupName&&e<=1)r=t.getAttribute("formgroupname")||t.getAttribute("fromGroupName");else if(this.container instanceof s.NgModelGroup&&e<=1)r=this.container.name;else{var o=this.getSlibingFormContrlElem(this.elemRef.nativeElement);r=o.getAttribute("formcontrolname")||o.getAttribute("formControlName")||o.getAttribute("name")}return r},r.prototype.getPath=function(r,t,e){if(!(t instanceof s.FormGroup))return r===t?e:"";var o=[];for(var n in t.controls){if(t.controls[n]===r)return n;if(t.controls[n]instanceof s.FormGroup){var i=this.getPath(r,t.controls[n],e);if(i)return o.push(n),o.push(i),o.join(".")}}return o.join(".")},r.decorators=[{type:t.Component,args:[{selector:l,template:'<span\n    class="error"\n    [ngClass]="errorPrompt"\n    [hidden]="!errorMsg"\n>\n    <ng-container\n        [ngTemplateOutlet]="template"\n        [ngTemplateOutletContext]="{errorMsg:errorMsg}"\n    ></ng-container>\n    <p *ngIf="!template">{{errorMsg}}</p>\n</span>\n',styles:["p{width:100%;height:17px;line-height:17px;color:#e06a2f;float:left}"]}]}],r.ctorParameters=function(){return[{type:String,decorators:[{type:t.Attribute,args:["controlName"]}]},{type:s.ControlContainer,decorators:[{type:t.Optional}]},{type:n},{type:i},{type:t.ElementRef}]},r.propDecorators={onlyGroup:[{type:t.Input}],errorPrompt:[{type:t.Input}],controlName:[{type:t.Input}],template:[{type:t.ContentChild,args:[t.TemplateRef]}]},r}(),m=function(){function r(r){this.msgServ=r}return Object.defineProperty(r.prototype,"validMsg",{set:function(r){r&&this.msgServ.resetMsg(r)},enumerable:!0,configurable:!0}),r.decorators=[{type:t.Directive,args:[{selector:"[isliFormValidMsg]",providers:[n]}]}],r.ctorParameters=function(){return[{type:n}]},r.propDecorators={validMsg:[{type:t.Input,args:["isliFormValidMsg"]}]},r}(),f={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return c}),multi:!0},c=function(){function r(){a.registerMsg("isbn","请输入正确的ISBN号")}return r.prototype.validate=function(r){if(!(r instanceof s.FormGroup))throw new Error("isbn must be a group control");var t=r.value;return t.isbn1&&t.isbn2&&t.isbn3&&t.isbn4&&t.isbn5&&this.validISBNCode([t.isbn1,t.isbn2,t.isbn3,t.isbn4,t.isbn5].join(""))?{isbn:!0}:null},r.prototype.validISBNCode=function(r){if("9999999999999"===r)return!0;if(!this.isBarCode(r))return!1;for(var t,e=0,o=0,n=1;n<=12;n++){var i=parseInt(r[n-1],10);n<=12&&n%2==0?e+=i:n<=11&&n%2==1&&(o+=i)}return((t=o+3*e)%10==0?t-t:t+(10-t%10)-t)===parseInt(r[12],10)},r.prototype.isBarCode=function(r){return 13===r.length&&null!=new RegExp(/^[0-9]{12}$/).exec(r.substring(0,12))},r.decorators=[{type:t.Directive,args:[{selector:"[mprIsbnValid]",providers:[f]}]}],r.ctorParameters=function(){return[]},r}(),p={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return g}),multi:!0},g=function(){function r(){a.registerMsg("isbnPart34","第三组和第四组一共为8位数字")}return r.prototype.validate=function(r){if(!(r instanceof s.FormGroup))throw new Error("isbn must be a group control");var t=r.value;return t.isbn3&&t.isbn4&&t.isbn3.length+t.isbn4.length!==8?{isbnPart34:!0}:null},r.decorators=[{type:t.Directive,args:[{selector:"[mprIsbnPartValid]",providers:[p]}]}],r.ctorParameters=function(){return[]},r}(),h={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return d}),multi:!0},d=function(){function r(){a.registerMsg("isbnHeader","第一组必须为978或979")}return r.prototype.validate=function(r){return r.value&&["999","978","979","000"].indexOf(r.value)<0?{isbnHeader:!0}:null},r.decorators=[{type:t.Directive,args:[{selector:"[mprIsbnHeaderValid]",providers:[h]}]}],r.ctorParameters=function(){return[]},r}(),v={provide:s.NG_VALIDATORS,useExisting:t.forwardRef(function(){return b}),multi:!0},b=function(){function r(){a.registerMsg("float","请输入浮点数")}return r.prototype.validate=function(r){var t=parseFloat(""+r.value);return isNaN(t)?{"float":!0}:null},r.decorators=[{type:t.Directive,args:[{selector:"[mprFloatOnlyValidtor]",providers:[v]}]}],r.ctorParameters=function(){return[]},r}(),y=function(){function r(r,t){this.elem=r,this.render=t}return r.prototype.ngOnInit=function(){this.elem.nativeElement&&this.elem.nativeElement.setAttribute?this.render.setAttribute(this.elem.nativeElement,"formgroup","formgroup"):this.elem.nativeElement&&this.elem.nativeElement.parentElement&&this.render.setAttribute(this.elem.nativeElement.parentElement,"formgroup","formgroup")},r.decorators=[{type:t.Directive,args:[{selector:"[formGroup]"}]}],r.ctorParameters=function(){return[{type:t.ElementRef},{type:t.Renderer2}]},r}(),M=function(){function r(){}return r.decorators=[{type:t.NgModule,args:[{imports:[e.CommonModule,s.ReactiveFormsModule,s.FormsModule],declarations:[u,m,c,g,d,b,y],exports:[u,m,c,g,d,s.ReactiveFormsModule,s.FormsModule,b,y],providers:[i,n]}]}],r}();r.FormValidModule=M,r.GlobalValidService=i,r.globalValidMsgServ=a,r.FormValidMsgService=n,r.FormControlValidComponent=u,r.FloatOnlyValidtorDirective=b,r.IsbnHeaderValidDirective=d,r.IsbnPartValidDirective=g,r.IsbnValidtorDirective=c,r.ɵc=y,r.ɵb=m,r.ɵa=o,Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=mpr-form-valid.umd.min.js.map