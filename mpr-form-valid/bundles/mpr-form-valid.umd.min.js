!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/forms"),require("rxjs"),require("rxjs/operators"),require("dom-scroll-into-view"),require("@angular/common")):"function"==typeof define&&define.amd?define("mpr-form-valid",["exports","@angular/core","@angular/forms","rxjs","rxjs/operators","dom-scroll-into-view","@angular/common"],e):e(r["mpr-form-valid"]={},r.ng.core,r.ng.forms,r.rxjs,r.rxjs.operators,null,r.ng.common)}(this,function(r,e,s,t,o,n,i){"use strict";n=n&&n.hasOwnProperty("default")?n["default"]:n;var l=function(){function r(){this.validMsg=new Map}return r.prototype.registerMsg=function(r,e){if(!r||!e)throw new Error("msg key and value must not empty");this.validMsg.set(r.toLowerCase(),e)},r.prototype.getMsg=function(r){return r?this.validMsg.get(r.toLowerCase()):null},r}(),a=new l,u=function(){function r(){this.validMsg={}}return r.prototype.setValidMsg=function(r,e){e&&(this.validMsg[r.toLowerCase()]=e)},r.prototype.getValidMsg=function(r,e){var t,o,n=Number.MAX_VALUE,i="";if(r=(r||"").toLowerCase(),!e||!r)return{errorMsg:i,minWeight:n};for(var s in e)if(e.hasOwnProperty(s)){var l=s;s=s.toLowerCase(),(t=this.formartMsg(this.validMsg[r+"."+s]||a.getMsg(s),e[l]))&&(o=Number.isNaN(Number(e[s]))?1e3:Number(e[s]))<n&&(n=o,i=t)}return{errorMsg:i,minWeight:n}},r.prototype.formartMsg=function(r,t){return"object"==typeof t&&t?r.replace(/\{(.+)\}/g,function(r,e){return t[e]||""}):r},r.prototype.resetMsg=function(r){if("object"!=typeof r)throw Error("form valid msg must be a object");for(var e in r)"object"!=typeof r[e]?this.validMsg[e.toLowerCase()]=r[e]:this.formatMsg(r[e],e.toLowerCase(),this.validMsg)},r.prototype.formatMsg=function(r,e,t){for(var o in r)"object"!=typeof r[o]?t[e+"."+o.toLowerCase()]=r[o]:this.formatMsg(r[o],e+"."+o.toLowerCase(),t)},r.decorators=[{type:e.Injectable}],r.ctorParameters=function(){return[]},r}();var m=function(){function r(){var e=this;this.validForms=[],this.needScroll=!1,this.scrollElem=[],this.doScrollObserv=t.Observable.create(function(r){e.scrollObserver=r}),this.scrollOptions=null,this.doScrollObserv.pipe(o.debounceTime(500)).subscribe(function(){if(e.needScroll&&e.scrollElem.length){e.needScroll=!1;var t,o=Number.MAX_VALUE;if(e.scrollElem.forEach(function(r){var e=r.getBoundingClientRect().top;e<o&&(o=e,t=r)}),t){var r=function(r){for(var e,t,o,n,i,s=r;s&&"body"!==(e=s.nodeName.toLowerCase());){var l=(t=s,o="overflowY",n=void 0,n=window.getComputedStyle,(i=n?n(t):t.currentStyle)?i[o.replace(/-(\w)/gi,function(r,e){return e.toUpperCase()})]:undefined);if(s!==r&&("auto"===l||"scroll"===l)&&s.scrollHeight>s.clientHeight)return s;s=s.parentNode}return"body"===e?s.ownerDocument:s}(t);r&&n(t,r,Object.assign({},{onlyScrollIfNeeded:!0,offsetTop:200},e.scrollOptions||{}))}}})}return r.prototype.registerValidForm=function(e,r){var t=this.validForms.findIndex(function(r){return r.form==e});0<=t?this.validForms[t].count+=1:(t=this.validForms.length,this.validForms.push({form:e,count:1,errorHooks:[]})),r&&this.validForms[t].errorHooks.push(r)},r.prototype.resetNull=function(){var t=this;this.validForms.forEach(function(r){r.form instanceof s.FormControl?(r.form.reset(null,{emitEvent:!1,onlySelf:!0}),r.form.setErrors(null,{emitEvent:!0}),r.form.markAsPristine()):(r.form.reset({},{emitEvent:!1,onlySelf:!0}),r.form.setErrors(null,{emitEvent:!1}),t.resetGroup(r.form)),r.sub&&r.sub.unsubscribe(),r.form._reset=!0;var e=r.form.valueChanges.subscribe(function(){r.form._reset=!1,r.sub.unsubscribe(),r.sub=null});r.sub=e})},r.prototype.scrollTo=function(r){this.needScroll&&(this.scrollElem.push(r),this.scrollObserver.next(r))},r.prototype.validAll=function(r,e){var t=this;void 0===r&&(r=!1),void 0===e&&(e=null),this.needScroll=r,this.scrollOptions=e,this.scrollElem=[];var o=!0;return this.validForms.forEach(function(e){e.form.disabled||(e.form.valid&&!e.form._reset||(e.form.markAsDirty(),e.form instanceof s.FormControl?(console.log(e.form.status,e.form),e.form._reset&&(e.form._reset=!1,e.form.setValue(e.form.value,{emitModelToViewChange:!1,emitViewToModelChange:!1,onlySelf:!0,emitEvent:!1})),e.form.statusChanges.emit(e.form.status)):t.validFormGroup(e.form),e.form.valid||e.errorHooks.forEach(function(r){r(e.form)})),o=e.form.valid&&o)}),o},r.prototype.unregisterValidForm=function(e,r){var t=this.validForms.findIndex(function(r){return r.form==e});if(0<=t&&1<this.validForms[t].count){if(this.validForms[t].count-=1,r){var o=this.validForms[t].errorHooks.indexOf(r);-1!=o&&this.validForms[t].errorHooks.splice(o,1)}}else this.validForms.splice(t,1)},r.prototype.validFormGroup=function(r){if(!r.disabled){var e=r.controls;for(var t in e)e.hasOwnProperty(t)&&(e[t].disabled||(e[t]instanceof s.FormGroup&&this.validFormGroup(e[t]),e[t].valid&&!e[t]._reset||(e[t].markAsDirty(),console.log(e[t].status,e[t]),e[t]._reset&&(e[t]._reset=!1,e[t].setValue(e[t].value,{emitModelToViewChange:!1,emitViewToModelChange:!1,onlySelf:!0,emitEvent:!1})),e[t].statusChanges.emit(e[t].status)),r.valid&&!r._reset||(r.markAsDirty(),r._reset&&(r._reset=!1,r.setValue(r.value,{onlySelf:!0,emitEvent:!1})),r.statusChanges.emit(e[t].status))))}},r.prototype.resetGroup=function(r){var e=r.controls;for(var t in e)e.hasOwnProperty(t)&&(e[t]instanceof s.FormGroup?(e[t].setErrors(null,{emitEvent:!1}),this.resetGroup(e[t])):e[t].setErrors(null,{emitEvent:!0}),e[t]._reset=!0,e[t].markAsPristine())},r.decorators=[{type:e.Injectable}],r.ctorParameters=function(){return[]},r}(),f="mpr-form-control-valid",c=function(){function r(r,e,t,o,n){this.container=e,this.errMsgServ=t,this.globalValidServ=o,this.elemRef=n,this.onlyGroup=!1,this.groupValidControlLength=1,this["delete"]=!1,r&&(this.controlName=r.replace(/'/g,""))}return r.prototype.ngOnInit=function(){},r.prototype.ngAfterViewInit=function(){var r=this;setTimeout(function(){r["delete"]||r.bindControlErrorMsg()},500)},r.prototype.bindControlErrorMsg=function(){var r=this;if(this.controlName=this.getFormControlName(),!this.controlName)throw new Error("can't find controlName");console.log(this.controlName);var e="";if(this.container.control.get(this.controlName)&&this.container.control.get(this.controlName)instanceof s.FormControl?(this.formControl=this.container.control.get(this.controlName),e=this.getPath(this.formControl,this.formControl.root,this.controlName),this.formControl.statusChanges.subscribe(function(){r.errorMsg=r.errMsgServ.getValidMsg(e||r.controlName,r.formControl.errors).errorMsg,r.errorMsg&&Promise.resolve(null).then(function(){r.globalValidServ.scrollTo(r.elemRef.nativeElement)})})):(this.formControl=this.container.control,e=this.getPath(this.formControl,this.formControl.root,this.controlName),this.formControl.statusChanges.subscribe(function(){r.onlyGroup?r.errorMsg=r.errMsgServ.getValidMsg(e||r.controlName,r.formControl.errors).errorMsg:r.errorMsg=r.getGroupControlValidMsg(r.formControl,e||r.controlName,{minWeight:Number.MAX_VALUE,errorMsg:""}).errorMsg})),!this.formControl)throw new Error("formControl instance not find");this.globalValidServ.registerValidForm(this.formControl.root||this.formControl,this.errorHook)},r.prototype.ngOnDestroy=function(){this.formControl&&this.globalValidServ.unregisterValidForm(this.formControl.root||this.formControl,this.errorHook),this["delete"]=!0},r.prototype.setFormControlMsgListener=function(r,e){var t=this;if(r.valueChanges.subscribe(function(){t.errMsgServ.getValidMsg(e||t.controlName,r.errors)}),r instanceof s.FormGroup)for(var o in r.controls)this.setFormControlMsgListener(r.get(o),e+"."+o)},r.prototype.getGroupControlValidMsg=function(r,e,t){if(r instanceof s.FormControl&&!r.pristine)return this.errMsgServ.getValidMsg(e,r.errors);if(r instanceof s.FormControl&&r.pristine)return"";var o;for(var n in r.controls)(o=this.getGroupControlValidMsg(r.get(n),e+"."+n,t))&&o.minWeight<t.minWeight&&(t=o);return r.pristine||(o=this.errMsgServ.getValidMsg(e,r.errors)),o&&o.minWeight<t.minWeight&&(t=o),t},r.prototype.getParentGroupELem=function(){for(var r=this.elemRef.nativeElement.parentElement;r&&!r.getAttribute("formgroupname")&&!r.getAttribute("formGroupName")&&!r.getAttribute("formgroup")&&"form"!==r.nodeName.toLocaleLowerCase()&&"ngform"!==r.nodeName.toLocaleLowerCase();)r=r.parentElement;if(!r)throw console.log(this.elemRef.nativeElement),new Error("can not find parentElement");return r},r.prototype.getSlibingFormContrlElem=function(r){for(var e=r.previousElementSibling;e&&!e.hasAttribute("formcontrolname")&&!e.hasAttribute("formControlName")&&!e.hasAttribute("name");)e=e.previousElementSibling;if(!e)throw new Error("mpr-form-control-valid must have a formcontrol sibiling");return e},r.prototype.getFormControlName=function(){if(this.controlName)return this.controlName;var r;if(!this.container)throw new Error("only one [formControl] not support, There must be a formGroupName or [formGroup]");var e=this.getParentGroupELem(),t=e.querySelectorAll(f).length;if(this.groupValidControlLength=t,this.container instanceof s.FormGroupDirective&&t<=1)throw new Error("you should set controlName by yourself");if(this.container instanceof s.FormGroupName&&t<=1)r=e.getAttribute("formgroupname")||e.getAttribute("fromGroupName");else if(this.container instanceof s.NgModelGroup&&t<=1)r=this.container.name;else{var o=this.getSlibingFormContrlElem(this.elemRef.nativeElement);r=o.getAttribute("formcontrolname")||o.getAttribute("formControlName")||o.getAttribute("name")}return r},r.prototype.getPath=function(r,e,t){if(!(e instanceof s.FormGroup))return r===e?t:"";var o=[];for(var n in e.controls){if(e.controls[n]===r)return n;if(e.controls[n]instanceof s.FormGroup){var i=this.getPath(r,e.controls[n],t);if(i)return o.push(n),o.push(i),o.join(".")}}return o.join(".")},r.decorators=[{type:e.Component,args:[{selector:f,template:'<span\n    class="error"\n    [ngClass]="errorPrompt"\n    [hidden]="!errorMsg"\n>\n    <ng-container\n        [ngTemplateOutlet]="template"\n        [ngTemplateOutletContext]="{errorMsg:errorMsg}"\n    ></ng-container>\n    <p *ngIf="!template">{{errorMsg}}</p>\n</span>\n',styles:["p{width:100%;height:17px;line-height:17px;color:#e06a2f;float:left}"]}]}],r.ctorParameters=function(){return[{type:String,decorators:[{type:e.Attribute,args:["controlName"]}]},{type:s.ControlContainer,decorators:[{type:e.Optional}]},{type:u},{type:m},{type:e.ElementRef}]},r.propDecorators={onlyGroup:[{type:e.Input}],errorPrompt:[{type:e.Input}],controlName:[{type:e.Input}],errorHook:[{type:e.Input}],template:[{type:e.ContentChild,args:[e.TemplateRef]}]},r}(),p=function(){function r(r){this.msgServ=r}return Object.defineProperty(r.prototype,"validMsg",{set:function(r){r&&this.msgServ.resetMsg(r)},enumerable:!0,configurable:!0}),r.decorators=[{type:e.Directive,args:[{selector:"[isliFormValidMsg]",providers:[u]}]}],r.ctorParameters=function(){return[{type:u}]},r.propDecorators={validMsg:[{type:e.Input,args:["isliFormValidMsg"]}]},r}(),g={provide:s.NG_VALIDATORS,useExisting:e.forwardRef(function(){return d}),multi:!0},d=function(){function r(){a.registerMsg("isbn","请输入正确的ISBN号")}return r.prototype.validate=function(r){if(!(r instanceof s.FormGroup))throw new Error("isbn must be a group control");var e=r.value;return e.isbn1&&e.isbn2&&e.isbn3&&e.isbn4&&e.isbn5&&this.validISBNCode([e.isbn1,e.isbn2,e.isbn3,e.isbn4,e.isbn5].join(""))?{isbn:!0}:null},r.prototype.validISBNCode=function(r){if("9999999999999"===r)return!0;if(!this.isBarCode(r))return!1;for(var e,t=0,o=0,n=1;n<=12;n++){var i=parseInt(r[n-1],10);n<=12&&n%2==0?t+=i:n<=11&&n%2==1&&(o+=i)}return((e=o+3*t)%10==0?e-e:e+(10-e%10)-e)===parseInt(r[12],10)},r.prototype.isBarCode=function(r){return 13===r.length&&null!=new RegExp(/^[0-9]{12}$/).exec(r.substring(0,12))},r.decorators=[{type:e.Directive,args:[{selector:"[mprIsbnValid]",providers:[g]}]}],r.ctorParameters=function(){return[]},r}(),h={provide:s.NG_VALIDATORS,useExisting:e.forwardRef(function(){return v}),multi:!0},v=function(){function r(){a.registerMsg("isbnPart34","第三组和第四组一共为8位数字")}return r.prototype.validate=function(r){if(!(r instanceof s.FormGroup))throw new Error("isbn must be a group control");var e=r.value;return e.isbn3&&e.isbn4&&e.isbn3.length+e.isbn4.length!==8?{isbnPart34:!0}:null},r.decorators=[{type:e.Directive,args:[{selector:"[mprIsbnPartValid]",providers:[h]}]}],r.ctorParameters=function(){return[]},r}(),b={provide:s.NG_VALIDATORS,useExisting:e.forwardRef(function(){return y}),multi:!0},y=function(){function r(){a.registerMsg("isbnHeader","第一组必须为978或979")}return r.prototype.validate=function(r){return r.value&&["999","978","979","000"].indexOf(r.value)<0?{isbnHeader:!0}:null},r.decorators=[{type:e.Directive,args:[{selector:"[mprIsbnHeaderValid]",providers:[b]}]}],r.ctorParameters=function(){return[]},r}(),C={provide:s.NG_VALIDATORS,useExisting:e.forwardRef(function(){return M}),multi:!0},M=function(){function r(){a.registerMsg("float","请输入浮点数")}return r.prototype.validate=function(r){var e=parseFloat(""+r.value);return isNaN(e)?{"float":!0}:null},r.decorators=[{type:e.Directive,args:[{selector:"[mprFloatOnlyValidtor]",providers:[C]}]}],r.ctorParameters=function(){return[]},r}(),E=function(){function r(r,e){this.elem=r,this.render=e}return r.prototype.ngOnInit=function(){this.elem.nativeElement&&this.elem.nativeElement.setAttribute?this.render.setAttribute(this.elem.nativeElement,"formgroup","formgroup"):this.elem.nativeElement&&this.elem.nativeElement.parentElement&&this.render.setAttribute(this.elem.nativeElement.parentElement,"formgroup","formgroup")},r.decorators=[{type:e.Directive,args:[{selector:"[formGroup]"}]}],r.ctorParameters=function(){return[{type:e.ElementRef},{type:e.Renderer2}]},r}(),w=function(){function r(r,e){this.elem=r,this.render=e}return r.prototype.ngOnInit=function(){this.elem.nativeElement&&this.elem.nativeElement.setAttribute?this.render.setAttribute(this.elem.nativeElement,"formgroup","formgroup"):this.elem.nativeElement&&this.elem.nativeElement.parentElement&&this.render.setAttribute(this.elem.nativeElement.parentElement,"formgroup","formgroup")},r.decorators=[{type:e.Directive,args:[{selector:"form,ngForm,[ngForm]"}]}],r.ctorParameters=function(){return[{type:e.ElementRef},{type:e.Renderer2}]},r}(),F=function(){function r(){}return r.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule,s.ReactiveFormsModule,s.FormsModule],declarations:[c,p,d,v,y,M,E,w],exports:[c,p,d,v,y,s.ReactiveFormsModule,s.FormsModule,M,E,w],providers:[m,u]}]}],r}();r.FormValidModule=F,r.GlobalValidService=m,r.globalValidMsgServ=a,r.FormValidMsgService=u,r.FormControlValidComponent=c,r.FloatOnlyValidtorDirective=M,r.IsbnHeaderValidDirective=y,r.IsbnPartValidDirective=v,r.IsbnValidtorDirective=d,r.ɵc=E,r.ɵb=p,r.ɵd=w,r.ɵa=l,Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=mpr-form-valid.umd.min.js.map